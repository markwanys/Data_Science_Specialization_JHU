```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE,eval=TRUE)
library(dplyr)
library(leaflet)
library(maps)
```

```{r load data}
covid <- read.csv('owid-covid-data.csv', stringsAsFactors = FALSE,sep=',')
data(world.cities)
```

```{r clean data}
world.cities <- world.cities %>%
  filter(capital==1) %>%
  select(country=country.etc,lat,lng=long)
```

```{r clean covid data}
covid$date <- as.Date(covid$date,format="%Y-%m-%d")
covid$total_cases <- as.numeric(covid$total_cases)
covid <- covid %>%
  filter(!is.na(total_cases)) %>%
  filter(location!=c('International','World')) %>%
  mutate(location=replace(location,location=="United States","USA")) %>%
  mutate(location=replace(location,location=="United Kingdom","UK")) %>%
  select(country=location,date,total_cases) %>%
  group_by(country) %>%
  arrange(desc(date)) %>%
  summarise(total_cases=first(total_cases),Date=first(date)) %>%
  inner_join(world.cities,by="country")
```

## **Global Active COVID Cases as of `r Sys.Date()`**
```{r leaflet plot,eval=TRUE}
labs <- lapply(seq(nrow(covid)), function(i) {
  paste0( '<p><b>', covid[i, "country"], '</b></p><p>', 
          prettyNum(covid[i, "total_cases"],big.mark = ","), '</p> ') 
})

as.data.frame(covid) %>%
  leaflet() %>%
  addTiles() %>%
  addCircles(weight=1,radius=covid$total_cases/10,color='red',label=lapply(labs, htmltools::HTML))
```


